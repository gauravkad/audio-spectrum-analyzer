<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>14-Band Rainbow Spectrum Analyzer</title>
  <style>
    canvas {
      width: 100%;
      height: 420px;
      background: black;
      display: block;
    }
  </style>
</head>
<body>
  <h2 style="text-align:center;">14-Band Rainbow Spectrum Analyzer</h2>
  <canvas id="spectrum"></canvas>

  <script>
    const canvas = document.getElementById('spectrum');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = 420;

    async function setupAudio() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const source = audioCtx.createMediaStreamSource(stream);
      const analyser = audioCtx.createAnalyser();

      analyser.fftSize = 2048;
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      const timeDomainData = new Uint8Array(analyser.fftSize);

      source.connect(analyser);

      function draw() {
        requestAnimationFrame(draw);

        analyser.getByteFrequencyData(dataArray);
        analyser.getByteTimeDomainData(timeDomainData);

        ctx.fillStyle = 'black';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Draw dB scale
        ctx.fillStyle = 'white';
        ctx.font = '12px Arial';
        const dbSteps = [0, -10, -20, -30, -40, -50, -60, -70, -80];
        dbSteps.forEach((db, i) => {
          const y = canvas.height - 40 - (i * (canvas.height - 80) / dbSteps.length);
          ctx.fillText(`${db} dB`, 5, y);
          ctx.strokeStyle = 'gray';
          ctx.beginPath();
          ctx.moveTo(50, y);
          ctx.lineTo(canvas.width, y);
          ctx.stroke();
        });

        // Draw 14 rainbow LED bars
        const sampleRate = audioCtx.sampleRate;
        const nyquist = sampleRate / 2;
        const bandCount = 14;
        const bandWidth = (canvas.width - 60) / bandCount;
        const freqStep = nyquist / bufferLength;

        for (let band = 0; band < bandCount; band++) {
          const startFreq = 20 + band * 1500;
          const endFreq = startFreq + 1500;
          const startIndex = Math.floor(startFreq / freqStep);
          const endIndex = Math.min(Math.floor(endFreq / freqStep), bufferLength);

          let sum = 0;
          for (let i = startIndex; i < endIndex; i++) {
            sum += dataArray[i];
          }
          const avg = sum / (endIndex - startIndex);
          const barHeight = (avg / 255) * (canvas.height - 80);

          const hue = (band / bandCount) * 360;
          ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
          const x = 60 + band * bandWidth;
          ctx.fillRect(x, canvas.height - barHeight - 40, bandWidth - 4, barHeight);
          ctx.strokeStyle = 'black';
          ctx.strokeRect(x, canvas.height - barHeight - 40, bandWidth - 4, barHeight);

          // Frequency label
          const labelFreq = startFreq + 750;
          ctx.fillStyle = 'white';
          ctx.textAlign = 'center';
          ctx.fillText(`${labelFreq >= 1000 ? (labelFreq / 1000).toFixed(1) + 'k' : labelFreq}Hz`, x + bandWidth / 2 - 2, canvas.height - 25);
        }

        // Volume meter
        let sumSquares = 0;
        for (let i = 0; i < timeDomainData.length; i++) {
          const normalized = (timeDomainData[i] - 128) / 128;
          sumSquares += normalized * normalized;
        }
        const rms = Math.sqrt(sumSquares / timeDomainData.length);
        const volume = rms * canvas.width;

        ctx.fillStyle = 'lime';
        ctx.fillRect(0, canvas.height - 20, volume, 10);
        ctx.strokeStyle = 'white';
        ctx.strokeRect(0, canvas.height - 20, canvas.width, 10);
      }

      draw();
    }

    setupAudio().catch(err => {
      alert('Microphone access denied or not supported.');
      console.error(err);
    });
  </script>
</body>
</html>
